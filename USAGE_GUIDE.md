# 优化后的项目使用指南

## 🎉 新功能概览

### 1. **错误重试机制**
- 网络请求自动重试（最多3次）
- 指数退避策略，避免服务器压力
- 详细的重试日志

### 2. **交互式按钮**
- 🔄 重新检测 - 刷新订阅信息
- 🗑️ 删除订阅 - 一键删除
- 🏷️ 添加标签 - 订阅分组管理

### 3. **订阅分组管理**
- 为订阅添加标签（主力、备用、测试等）
- 按标签检测：`/check 主力`
- 按标签查看：`/list`

### 4. **导出/导入功能**
- `/export` - 导出所有订阅为 JSON 文件
- 回复文件进行导入（支持合并和覆盖）

### 5. **异步处理**
- 并发检测多个订阅，速度更快
- 内存优化，适合小内存 VPS
- 懒加载机制，按需初始化

### 6. **单元测试**
- 完整的测试覆盖
- 代码质量保证
- 持续集成支持

---

## 📦 安装和部署

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 配置环境变量
编辑 `.env` 文件：
```
TELEGRAM_BOT_TOKEN=你的机器人Token
```

### 3. 运行机器人

**异步版本（推荐）：**
```bash
python bot_async.py
```

**手动轮询版本（Windows 兼容）：**
```bash
python bot_manual.py
```

---

## 🧪 运行测试

### 运行所有测试
```bash
pytest
```

### 运行特定测试
```bash
pytest tests/test_utils.py
pytest tests/test_storage.py
pytest tests/test_parser.py
```

### 查看代码覆盖率
```bash
pytest --cov=. --cov-report=html
```
然后打开 `htmlcov/index.html` 查看详细报告。

---

## 📖 使用说明

### 基本命令

| 命令 | 说明 |
|------|------|
| `/start` | 查看欢迎信息 |
| `/help` | 查看帮助 |
| `/check` | 检测所有订阅 |
| `/check [标签]` | 检测指定标签的订阅 |
| `/list` | 查看订阅列表（按标签分组） |
| `/stats` | 查看统计信息 |
| `/export` | 导出所有订阅 |

### 添加订阅
直接发送订阅链接即可，支持批量（每行一个）。

### 订阅管理
1. 发送订阅链接后，会显示交互式按钮
2. 点击 **🏷️ 添加标签** 按钮
3. 回复消息输入标签名（如：主力、备用）

### 批量检测
```
/check          # 检测所有订阅
/check 主力     # 只检测"主力"标签的订阅
```

### 导出导入
1. 导出：发送 `/export`，机器人会发送 JSON 文件
2. 导入：回复导出的文件，机器人会自动导入

---

## 🚀 性能优化

### 内存优化
- **懒加载**：解析器和存储按需初始化
- **并发控制**：最多同时3个请求，避免内存溢出
- **及时释放**：使用完立即释放资源

### 适合小内存 VPS
- 异步处理，非阻塞
- 流式处理，不缓存大量数据
- 原子文件写入，避免数据损坏

---

## 🔧 代码质量

### 类型提示
所有函数都有完整的类型提示，便于 IDE 自动补全和类型检查。

### 文档字符串
每个函数都有详细的文档说明，包括参数、返回值和示例。

### 异常处理
完善的异常处理机制，避免程序崩溃。

### 日志记录
详细的日志输出，便于调试和监控。

---

## 📊 项目结构

```
dingyue_TG/
├── bot_async.py              # 异步机器人主程序（推荐）
├── bot_manual.py             # 手动轮询版本（Windows）
├── parser.py                 # 订阅解析器
├── storage_enhanced.py       # 增强存储模块
├── retry_utils.py            # 重试机制工具
├── utils.py                  # 工具函数
├── requirements.txt          # 依赖列表
├── pytest.ini                # 测试配置
├── tests/                    # 测试目录
│   ├── __init__.py
│   ├── test_utils.py         # 工具函数测试
│   ├── test_storage.py       # 存储模块测试
│   ├── test_parser.py        # 解析器测试
│   └── test_retry.py         # 重试机制测试
└── data/                     # 数据目录
    └── subscriptions.json    # 订阅数据
```

---

## 🐛 故障排除

### 问题：导入错误
**解决方案：** 确保安装了所有依赖
```bash
pip install -r requirements.txt
```

### 问题：机器人无响应
**解决方案：** 检查 Token 是否正确配置
```bash
cat .env  # 查看配置
```

### 问题：测试失败
**解决方案：** 检查 Python 版本（需要 3.8+）
```bash
python --version
```

---

## 📝 更新日志

### v2.0.0 (2026-02-13)
- ✅ 添加错误重试机制
- ✅ 实现交互式按钮
- ✅ 支持订阅分组管理
- ✅ 添加导出/导入功能
- ✅ 异步处理优化
- ✅ 完整的单元测试
- ✅ 内存优化（适合小 VPS）

---

## 📄 许可证

MIT License
